#!/usr/bin/env bash

# NOTE: this requires ghostscript to be installed.

hostname=`hostname`
date_string=`date +%Y%m%d.%H%M`
destination="/home/pavel/pavelcam/pavelcam.$hostname.$date_string.jpg"
key=$HOME/.ssh/id_dsa_pavelcam
WIFI=`/System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport -I | grep ' SSID' | cut -d : -f 2 | cut -c 2-`

echo "Taking pavelcam picture at $date_string"

# Capture image.
if [[ ! -z $1 && "$WIFI" == "wlBazaar" ]]; then
    echo "$date_string: Not taking photo on BazaarVoice wifi"
elif [[ ! -z $1 && "$WIFI" == "BVAir" ]]; then
    echo "$date_string: Not taking photo on BazaarVoice wifi"
elif [[ ! -z $1 && "$WIFI" == "guestBazaar" ]]; then
    echo "$date_string: Not taking photo on BazaarVoice wifi"
elif [[ ! -z $1 && "$WIFI" == "wifi.bazaarvoice.com" ]]; then
    echo "$date_string: Not taking photo on BazaarVoice wifi"
elif ! $HOME/bin/isightcapture -w 720 -h 480 -t jpg $HOME/Temp/pavelcam.jpg; then
        echo "$date_string: Unable take photo."
else
    # Copy image to isight folder.
    mkdir -p $HOME/Pictures/isight/`date +%Y`/`date +%m`/
    cp $HOME/Temp/pavelcam.jpg $HOME/Pictures/isight/`date +%Y`/`date +%m`/pavelcam.$hostname.$date_string.jpg

    # Tag picture with date
    /usr/local/bin/convert $HOME/Temp/pavelcam.jpg -pointsize 20 -fill white -draw "text 434,474 '`date '+%Y-%m-%d %H:%M'`'" -fill black -draw "text 436,476 '`date '+%Y-%m-%d %H:%M'`'" $HOME/Temp/pavelcam_date.jpg

    # Upload to server.
    scp -i $key $HOME/Temp/pavelcam_date.jpg pavelcam@lishin.org:$destination

    # Symlink across domains
    ssh -i $key pavelcam@lishin.org "cp $destination /var/domains/widgetsex.com/pavelcam.jpg; cp $destination /var/domains/lishin.org/pavelcam.jpg; cp $destination /var/domains/pavel.lishin.org/pavelcam.jpg; rm $destination;"
fi
